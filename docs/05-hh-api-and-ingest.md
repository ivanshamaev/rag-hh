# hh.ru API и пайплайн индексации

Как проект получает вакансии с HeadHunter, как готовит текст для эмбеддингов и как устроен процесс индексации. Полезно при доработке загрузки, фильтров или формата данных.

---

## 1. HeadHunter API: основы

- Документация: https://dev.hh.ru/
- Публичный доступ: многие методы работают без авторизации (в т.ч. поиск вакансий).
- Лимиты: без авторизации — порядка 5 запросов в минуту с одного IP; в коде между запросами страниц стоит `time.sleep(1.2)`.

Используемые эндпоинты в проекте:

- **GET https://api.hh.ru/vacancies** — поиск: параметры `text`, `per_page`, `page`, `search_field` и др. В ответе — список кратких объектов (id, name, employer, area, salary, snippet и т.д.).
- **GET https://api.hh.ru/vacancies/{id}** — полное описание одной вакансии (в т.ч. поле `description` с HTML, `key_skills`).

---

## 2. Поиск вакансий (fetch_vacancies)

В `app/hh_client.py`:

- Параметры: `text` (поисковая строка), `per_page` (например 100), `max_pages` (сколько страниц забрать).
- Цикл по `page` от 0: запрос с `params={ "text": text, "per_page": per_page, "page": page, "search_field": "name" }`.
- Ответ: `data["items"]` — список вакансий; `data["pages"]` — общее число страниц. Цикл прерывается, когда страниц больше нет или достигнут `max_pages`.
- Между итерациями — `time.sleep(1.2)` для соблюдения лимитов.

Возвращается плоский список кратких вакансий (у каждого есть `id` для последующей загрузки деталей).

---

## 3. Детали вакансии (fetch_vacancy_detail)

- Один запрос **GET /vacancies/{vacancy_id}**.
- При 404 возвращаем `None`; при успехе — полный JSON (описание в HTML, навыки, зарплата, работодатель, регион и т.д.).
- Именно эти полные объекты используются для построения текста под эмбеддинг и для сохранения в БД.

---

## 4. Подготовка текста для эмбеддинга (vacancy_to_text)

Цель: один текстовый «документ» без разметки, по которому мы считаем эмбеддинг. От качества этого текста зависит качество семантического поиска.

Текущая логика в `vacancy_to_text()`:

1. **Название** — `v["name"]`.
2. **Описание** — `v["description"]`:
   - замена типичных HTML-тегов на пробел;
   - удаление оставшихся тегов через `re.sub(r'<[^>]+>', ' ', desc)`;
   - схлопывание пробелов;
   - обрезка до 3000 символов (ограничение длины под модель).
3. **Навыки** — если есть `v["key_skills"]`, строка вида «Навыки: Python, SQL, …».

Всё склеивается через `"\n"`. Итог — один блок текста для `embed()` / `embed_batch()`.

Best practices при доработке:

- Не включать в текст для эмбеддинга то, по чему не хотите искать (например, только название без описания — беднее семантика).
- Сохранять порядок: название → описание → навыки — часто помогает модели.
- Длина: укладываться в лимит модели (типично 512 токенов); 3000 символов — разумный компромисс для русскоязычных описаний.

---

## 5. Пайплайн индексации (load_and_index_vacancies)

В `app/vacancies.py`:

1. **Список кратких вакансий**: `fetch_vacancies(search_query, per_page=20, max_pages=3)`.
2. **Ограничение**: берём не более `max_vacancies` (например 50) с начала списка.
3. **Детали**: для каждого элемента вызываем `fetch_vacancy_detail(id)`; пропускаем 404/ошибки.
4. **Тексты**: `texts = [vacancy_to_text(v) for v in vacancies_data]`.
5. **Эмбеддинги**: `embeddings = embed_batch(texts, batch_size=32)`.
6. **БД**: одна транзакция: для каждой пары (вакансия, вектор) вызывается `upsert_vacancy(..., embedding=emb)`; в конце `conn.commit()`.

Возвращается количество реально записанных вакансий.

Важно: при большом `max_vacancies` и лимитах hh.ru индексация может занимать время; при необходимости можно добавить повторные попытки (retry) и логирование.

---

## 6. Сохранение в БД (upsert_vacancy)

- **Ключ уникальности** — `hh_id` (внешний id с hh.ru). При повторной индексации той же вакансии делается UPDATE.
- Поля: название, описание, работодатель, регион, зарплата (from/to), url, дата публикации, вектор.
- Вектор передаётся как строка из `list_to_pgvector(embedding)` и в SQL приводится к `::vector`.

Так мы можем периодически перезапускать индексацию по тем же запросам и обновлять изменившиеся вакансии без дубликатов.

---

## 7. Где что лежит в коде

| Задача | Файл | Функция |
|--------|------|--------|
| Поиск вакансий по тексту | `app/hh_client.py` | `fetch_vacancies()` |
| Получение одной вакансии | `app/hh_client.py` | `fetch_vacancy_detail()` |
| Текст для эмбеддинга | `app/hh_client.py` | `vacancy_to_text()` |
| Полный цикл индексации | `app/vacancies.py` | `load_and_index_vacancies()` |
| Запись в БД | `app/vacancies.py` | `upsert_vacancy()` |
| Точка входа API | `app/main.py` | `POST /ingest` → `load_and_index_vacancies()` |

Дальше: [Docker и эксплуатация](06-docker-and-operations.md) — как запускать, настраивать и поддерживать проект.
